name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  # Automatic review on new/updated PRs
  claude-code-review:
    # Only run for PRs from shepherdjerred on PR events (not comments)
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.user.login == 'shepherdjerred'
    runs-on: [monorepo-runner-set]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: 1password/load-secrets-action/configure@v2
        with:
          connect-host: http://onepassword-connect.1password.svc.cluster.local:8080
          connect-token: ${{ secrets.OP_CONNECT_TOKEN }}

      - uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: op://bic45kuflnwsnxnd67dzcnxjze/5p65mbzr237yyzt2sfnfao3a5a/CLAUDE_CODE_OAUTH_TOKEN

      # Install GitHub CLI early for PR analysis script
      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Analyze PR complexity and history
        id: analyze-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          bash .github/scripts/analyze-pr-complexity.sh

      - name: Review PR with Claude
        id: claude-review
        # Skip if analysis determined this is trivial
        if: steps.analyze-pr.outputs.should_skip != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ env.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          track_progress: true
          # JSON schema for structured output: { should_approve: bool, confidence: 0-100, issue_count: { critical, major, minor, nitpick }, reasoning: string }
          # Dynamic max-turns based on complexity analysis
          claude_args: "--max-turns ${{ steps.analyze-pr.outputs.max_turns }} --model claude-opus-4-5-20251101 --json-schema '{\"type\":\"object\",\"properties\":{\"should_approve\":{\"type\":\"boolean\",\"description\":\"Whether to approve the PR (true) or not (false)\"},\"confidence\":{\"type\":\"number\",\"description\":\"Confidence level 0-100 in the approval decision\"},\"issue_count\":{\"type\":\"object\",\"properties\":{\"critical\":{\"type\":\"number\"},\"major\":{\"type\":\"number\"},\"minor\":{\"type\":\"number\"},\"nitpick\":{\"type\":\"number\"}},\"required\":[\"critical\",\"major\",\"minor\",\"nitpick\"]},\"reasoning\":{\"type\":\"string\",\"description\":\"Brief explanation of the approval/rejection decision\"}},\"required\":[\"should_approve\",\"confidence\",\"issue_count\",\"reasoning\"]}'"
          prompt: |
            ${{ steps.analyze-pr.outputs.is_rereview == 'true' && steps.analyze-pr.outputs.previous_was_approved == 'true' && '## Re-Review Context

            This PR was previously APPROVED. Focus your review on:
            1. Changes since last approval (git diff of new commits)
            2. Whether new changes introduce any regressions or issues
            3. If no new issues: Keep reasoning BRIEF (1-2 sentences max)

            **Important**: If the new changes look good, simply note "New changes maintain previous quality standards" and approve. No need to re-review unchanged code or repeat previous comments.

            ---

            ' || '' }}Review this PR focusing on things linters and typecheckers can't catch:

            - **Functionality**: Does the code actually do what the PR claims? Are requirements met?
            - **Architectural fit**: Does this change fit the codebase patterns? Is it in the right place?
            - **Logic errors**: Are there bugs, race conditions, or edge cases that could cause problems?
            - **Security**: Any vulnerabilities that static analysis would miss?
            - **Design**: Is this the right approach? Are there simpler alternatives?
            - **Complexity**: Is the code over-engineered or hard to understand? Could it be simpler?
            - **Performance**: Any bottlenecks, inefficient algorithms, or scalability concerns?
            - **Error handling**: Are errors handled properly with useful error messages?
            - **Logging & Observability**: Is there sufficient logging for debugging? Can you trace what happened when something goes wrong? Are log levels appropriate (error/warn/info/debug)?
            - **Tests**: Are there appropriate tests? Do they cover edge cases, failure modes, and the happy path?
            - **Commit messages**: Are they clear and explain "why"?

            Read the CLAUDE.md file and explore related code to understand context. Use inline comments for specific suggestions. Be direct and concise - if something is fine, don't comment on it.

            ## Issue Severity Classification

            Classify each issue you find:
            - **Critical**: Security vulnerabilities, data loss risks, breaking changes
            - **Major**: Logic errors, race conditions, architectural violations
            - **Minor**: Suboptimal patterns, inconsistencies with conventions, in-scope improvements that could be addressed later
            - **Nitpick**: ONLY for things truly outside the PR's scope:
              - Feature additions beyond what the PR aims to do
              - Pure style preferences with no functional impact
              - "Nice to have" suggestions unrelated to the PR's purpose
              - Documentation improvements for unrelated code

            **Important**: If something is within the PR's scope and should be done (even if it could be deferred), classify it as Minor or higher, NOT as Nitpick. Nitpicks are reserved for genuinely out-of-scope suggestions.

            ## Approval Decision

            After your review, determine if this PR should be auto-approved:
            - âœ… **Approve** if: Zero critical, major, AND minor issues (nitpicks only are acceptable)
            - âŒ **Do not approve** if: ANY critical, major, or minor issues exist

            Provide your decision in the structured output with issue counts and reasoning.

      # Validate JSON output before attempting to use it
      - name: Validate structured output
        id: validate-output
        if: steps.claude-review.outputs.structured_output != ''
        env:
          STRUCTURED_OUTPUT: ${{ steps.claude-review.outputs.structured_output }}
        run: |
          # Attempt to parse JSON and validate required fields exist
          if echo "$STRUCTURED_OUTPUT" | jq -e '.should_approve' > /dev/null 2>&1 && \
             echo "$STRUCTURED_OUTPUT" | jq -e '.confidence' > /dev/null 2>&1 && \
             echo "$STRUCTURED_OUTPUT" | jq -e '.issue_count' > /dev/null 2>&1 && \
             echo "$STRUCTURED_OUTPUT" | jq -e '.reasoning' > /dev/null 2>&1; then
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "::warning::Structured output is missing required fields or is invalid JSON"
          fi

      - name: Auto-approve PR if no issues
        if: |
          steps.validate-output.outputs.valid == 'true' &&
          fromJSON(steps.claude-review.outputs.structured_output).should_approve == true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STRUCTURED_OUTPUT: ${{ steps.claude-review.outputs.structured_output }}
        run: |
          # Extract data from structured output with default values
          REASONING=$(echo "$STRUCTURED_OUTPUT" | jq -r '.reasoning // "No issues found"')
          NITPICK_COUNT=$(echo "$STRUCTURED_OUTPUT" | jq -r '.issue_count.nitpick // 0')
          CONFIDENCE=$(echo "$STRUCTURED_OUTPUT" | jq -r '.confidence // 0')

          # Validate numeric fields
          if ! [[ "$CONFIDENCE" =~ ^[0-9]+$ ]]; then CONFIDENCE=0; fi
          if ! [[ "$NITPICK_COUNT" =~ ^[0-9]+$ ]]; then NITPICK_COUNT=0; fi

          # Build approval message using heredoc for safer string handling
          BODY=$(cat <<EOF
          âœ… **Automated approval by Claude Code Review**

          No blocking issues found (confidence: ${CONFIDENCE}%).

          ${REASONING}

          $(if [ "$NITPICK_COUNT" -gt 0 ]; then echo "${NITPICK_COUNT} nitpick(s) noted in review comments are acceptable and don't block approval."; fi)
          EOF
          )

          # Approve the PR
          gh pr review ${{ github.event.pull_request.number }} \
            --approve \
            --body "$BODY"

      - name: Request changes if issues found
        # Run if review completed but should_approve is false
        if: |
          steps.validate-output.outputs.valid == 'true' &&
          fromJSON(steps.claude-review.outputs.structured_output).should_approve == false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STRUCTURED_OUTPUT: ${{ steps.claude-review.outputs.structured_output }}
          PREVIOUS_WAS_APPROVED: ${{ steps.analyze-pr.outputs.previous_was_approved }}
        run: |
          # Extract issue counts
          CRITICAL=$(echo "$STRUCTURED_OUTPUT" | jq -r '.issue_count.critical // 0')
          MAJOR=$(echo "$STRUCTURED_OUTPUT" | jq -r '.issue_count.major // 0')
          MINOR=$(echo "$STRUCTURED_OUTPUT" | jq -r '.issue_count.minor // 0')
          REASONING=$(echo "$STRUCTURED_OUTPUT" | jq -r '.reasoning // "Issues found"')

          # Build message
          if [ "$PREVIOUS_WAS_APPROVED" = "true" ]; then
            HEADER="âš ï¸ **Approval revoked - Changes requested**"
            CONTEXT="This PR was previously approved, but new changes introduce issues that need to be addressed."
          else
            HEADER="âŒ **Changes requested**"
            CONTEXT="Issues found that need to be addressed before approval."
          fi

          BODY=$(cat <<EOF
          ${HEADER}

          ${CONTEXT}

          **Issues found:**
          - Critical: ${CRITICAL}
          - Major: ${MAJOR}
          - Minor: ${MINOR}

          ${REASONING}

          Please review the inline comments and address the issues.
          EOF
          )

          # Request changes (revokes previous approval if any)
          gh pr review ${{ github.event.pull_request.number }} \
            --request-changes \
            --body "$BODY"

      - name: Comment on skipped trivial PR
        # Run if PR was skipped as trivial
        if: steps.analyze-pr.outputs.should_skip == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TOTAL_CHANGES: ${{ steps.analyze-pr.outputs.total_changes }}
          COMPLEXITY: ${{ steps.analyze-pr.outputs.complexity }}
        run: |
          BODY=$(cat <<EOF
          ðŸ¤– **Claude Code Review - Skipped**

          This PR appears to be a trivial merge/rebase with minimal code changes (${TOTAL_CHANGES} lines).

          Automatic review skipped to save tokens. If you believe this should be reviewed, please:
          1. Add a comment mentioning \`@claude\` to trigger interactive review, or
          2. Add more substantive changes to trigger automatic review
          EOF
          )

          gh pr comment ${{ github.event.pull_request.number }} \
            --body "$BODY"

  # Interactive responses to @claude mentions in comments
  claude-interactive:
    # Only run for comments from shepherdjerred that mention @claude
    if: |
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      github.event.comment.user.login == 'shepherdjerred' &&
      contains(github.event.comment.body, '@claude')
    runs-on: [monorepo-runner-set]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: 1password/load-secrets-action/configure@v2
        with:
          connect-host: http://onepassword-connect.1password.svc.cluster.local:8080
          connect-token: ${{ secrets.OP_CONNECT_TOKEN }}

      - uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: op://bic45kuflnwsnxnd67dzcnxjze/5p65mbzr237yyzt2sfnfao3a5a/CLAUDE_CODE_OAUTH_TOKEN

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ env.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: "@claude"
          track_progress: true
          claude_args: "--max-turns 30 --model claude-opus-4-5-20251101"
          prompt: |
            Respond to the question or request. Read CLAUDE.md and relevant code for context. Be direct and concise.
