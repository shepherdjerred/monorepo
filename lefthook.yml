glob_matcher: doublestar

pre-commit:
  jobs:
    # TIER 1: Fast checks (sequential, fail-fast)
    - name: tier-1
      group:
        piped: true
        jobs:
          - name: check-suppressions
            run: bun scripts/check-suppressions.ts

          - name: migration-guard
            run: bun scripts/guard-no-package-exclusions.ts

          - name: staged-lint
            group:
              parallel: true
              jobs:
                # --- lockfile ---
                - name: lockfile-check
                  glob: "**/package.json"
                  run: bun install --frozen-lockfile

                # --- eslint per package (staged files only) ---
                - name: eslint-birmel
                  root: "packages/birmel/"
                  glob: "packages/birmel/**/*.{ts,tsx,js,jsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-bun-decompile
                  root: "packages/bun-decompile/"
                  glob: "packages/bun-decompile/**/*.{ts,tsx,js,jsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-eslint-config
                  root: "packages/eslint-config/"
                  glob: "packages/eslint-config/**/*.{ts,tsx,js,jsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-tools
                  root: "packages/tools/"
                  glob: "packages/tools/**/*.{ts,tsx,js,jsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-web-shared
                  root: "packages/clauderon/web/shared/"
                  glob: "packages/clauderon/web/shared/**/*.{ts,tsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-web-client
                  root: "packages/clauderon/web/client/"
                  glob: "packages/clauderon/web/client/**/*.{ts,tsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-web-frontend
                  root: "packages/clauderon/web/frontend/"
                  glob: "packages/clauderon/web/frontend/**/*.{ts,tsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-mobile
                  root: "packages/clauderon/mobile/"
                  glob: "packages/clauderon/mobile/**/*.{ts,tsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: prettier-mobile
                  root: "packages/clauderon/mobile/"
                  glob: "packages/clauderon/mobile/**/*.{ts,tsx}"
                  run: bunx prettier --check {staged_files}

                - name: eslint-docs
                  root: "packages/clauderon/docs/"
                  glob: "packages/clauderon/docs/**/*.{ts,tsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-astro-opengraph-images
                  root: "packages/astro-opengraph-images/"
                  glob: "packages/astro-opengraph-images/**/*.{ts,tsx,js,jsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-better-skill-capped
                  root: "packages/better-skill-capped/"
                  glob: "packages/better-skill-capped/**/*.{ts,tsx,js,jsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-sjer-red
                  root: "packages/sjer.red/"
                  glob: "packages/sjer.red/**/*.{ts,tsx,js,jsx,astro}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-webring
                  root: "packages/webring/"
                  glob: "packages/webring/**/*.{ts,tsx,js,jsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-starlight-karma-bot
                  root: "packages/starlight-karma-bot/"
                  glob: "packages/starlight-karma-bot/**/*.{ts,tsx,js,jsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-scout-for-lol
                  root: "packages/scout-for-lol/"
                  glob: "packages/scout-for-lol/**/*.{ts,tsx,js,jsx,astro}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-discord-plays-pokemon-common
                  root: "packages/discord-plays-pokemon/packages/common/"
                  glob: "packages/discord-plays-pokemon/packages/common/**/*.{ts,tsx,js,jsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-discord-plays-pokemon-backend
                  root: "packages/discord-plays-pokemon/packages/backend/"
                  glob: "packages/discord-plays-pokemon/packages/backend/**/*.{ts,tsx,js,jsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-discord-plays-pokemon-frontend
                  root: "packages/discord-plays-pokemon/packages/frontend/"
                  glob: "packages/discord-plays-pokemon/packages/frontend/**/*.{ts,tsx,js,jsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-homelab
                  root: "packages/homelab/"
                  glob: "packages/homelab/**/*.{ts,tsx,js,jsx}"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                - name: eslint-dagger
                  root: ".dagger/"
                  glob: ".dagger/**/*.ts"
                  run: bunx eslint --fix {staged_files}
                  stage_fixed: true

                # --- cargo fmt ---
                - name: cargo-fmt
                  root: "packages/clauderon/"
                  glob: "packages/clauderon/**/*.rs"
                  run: cargo fmt

                # --- shellcheck ---
                - name: shellcheck
                  glob: "**/*.sh"
                  exclude:
                    - "node_modules/**"
                    - "**/node_modules/**"
                    - "**/Pods/**"
                  run: shellcheck --severity=warning {staged_files}

    # TIER 2: Conditional checks (parallel)
    - name: tier-2
      group:
        parallel: true
        jobs:
          # --- Rust ---
          - name: cargo-clippy
            root: "packages/clauderon/"
            glob:
              - "packages/clauderon/**/*.rs"
              - "packages/clauderon/Cargo.toml"
              - "packages/clauderon/Cargo.lock"
            run: cargo clippy --all-targets --all-features -- -D warnings

          - name: cargo-test
            root: "packages/clauderon/"
            glob:
              - "packages/clauderon/**/*.rs"
              - "packages/clauderon/Cargo.toml"
              - "packages/clauderon/Cargo.lock"
            run: cargo test

          - name: cargo-deny
            root: "packages/clauderon/"
            glob:
              - "packages/clauderon/**/*.rs"
              - "packages/clauderon/Cargo.toml"
              - "packages/clauderon/Cargo.lock"
            skip:
              - run: "! command -v cargo-deny >/dev/null 2>&1"
            run: cargo deny check

          # --- TypeScript typecheck per package ---
          - name: birmel-typecheck
            root: "packages/birmel/"
            glob: "packages/birmel/**/*.{ts,tsx}"
            run: bun run typecheck

          - name: birmel-test
            root: "packages/birmel/"
            glob: "packages/birmel/**/*.{ts,tsx}"
            run: bunx prisma generate && bun run test

          - name: bun-decompile-typecheck
            root: "packages/bun-decompile/"
            glob: "packages/bun-decompile/**/*.{ts,tsx}"
            run: bun run typecheck

          - name: eslint-config-typecheck
            root: "packages/eslint-config/"
            glob: "packages/eslint-config/**/*.{ts,tsx}"
            run: bun run typecheck

          - name: tools-typecheck
            root: "packages/tools/"
            glob: "packages/tools/**/*.{ts,tsx}"
            run: bun run typecheck

          - name: web-shared-typecheck
            root: "packages/clauderon/web/shared/"
            glob: "packages/clauderon/web/shared/**/*.{ts,tsx}"
            run: bun run typecheck

          - name: web-client-typecheck
            root: "packages/clauderon/web/client/"
            glob: "packages/clauderon/web/client/**/*.{ts,tsx}"
            run: bun run typecheck

          - name: web-frontend-typecheck
            root: "packages/clauderon/web/frontend/"
            glob: "packages/clauderon/web/frontend/**/*.{ts,tsx}"
            run: bun run typecheck

          - name: mobile-typecheck
            root: "packages/clauderon/mobile/"
            glob: "packages/clauderon/mobile/**/*.{ts,tsx}"
            run: bun run typecheck

          - name: mobile-format-check
            root: "packages/clauderon/mobile/"
            glob: "packages/clauderon/mobile/**/*.{ts,tsx}"
            run: bun run format:check

          - name: mobile-test
            root: "packages/clauderon/mobile/"
            glob: "packages/clauderon/mobile/**/*.{ts,tsx}"
            run: bun run test

          - name: astro-opengraph-images-typecheck
            root: "packages/astro-opengraph-images/"
            glob: "packages/astro-opengraph-images/**/*.{ts,tsx}"
            run: bun run typecheck

          - name: better-skill-capped-typecheck
            root: "packages/better-skill-capped/"
            glob: "packages/better-skill-capped/**/*.{ts,tsx}"
            run: bun run typecheck

          - name: sjer-red-typecheck
            root: "packages/sjer.red/"
            glob: "packages/sjer.red/**/*.{ts,tsx}"
            run: bun run typecheck

          - name: webring-typecheck
            root: "packages/webring/"
            glob: "packages/webring/**/*.{ts,tsx}"
            run: bun run typecheck

          - name: starlight-karma-bot-typecheck
            root: "packages/starlight-karma-bot/"
            glob: "packages/starlight-karma-bot/**/*.{ts,tsx}"
            run: bun run typecheck

          - name: scout-for-lol-typecheck
            root: "packages/scout-for-lol/"
            glob: "packages/scout-for-lol/**/*.{ts,tsx}"
            run: bun run typecheck

          - name: discord-plays-pokemon-typecheck
            root: "packages/discord-plays-pokemon/"
            glob: "packages/discord-plays-pokemon/**/*.{ts,tsx}"
            run: bun run typecheck

          - name: homelab-typecheck
            root: "packages/homelab/"
            glob: "packages/homelab/**/*.{ts,tsx}"
            run: bun run typecheck

          - name: full-typecheck
            glob: "tsconfig.base.json"
            run: bun run typecheck

          # --- Actionlint ---
          - name: actionlint
            glob: ".github/workflows/**/*.yml"
            skip:
              - run: "! command -v actionlint >/dev/null 2>&1"
            run: actionlint

          # --- Knip ---
          - name: knip
            glob:
              - "**/package.json"
              - "**/knip.json"
            run: bunx knip --no-exit-code

          # --- Compliance ---
          - name: compliance-check
            glob:
              - "packages/*/package.json"
              - "packages/*/eslint.config.*"
              - "packages/*/tsconfig.json"
            run: bash scripts/compliance-check.sh

          # --- Quality ratchet ---
          - name: quality-ratchet
            glob: "**/*.{ts,tsx,rs}"
            run: bash scripts/quality-ratchet.sh
