name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

jobs:
  # Automatic review on new/updated PRs
  claude-code-review:
    # Only run for PRs from shepherdjerred on PR events (not comments)
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.user.login == 'shepherdjerred'
    runs-on: [monorepo-runner-set]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: 1password/load-secrets-action/configure@v2
        with:
          connect-host: http://onepassword-connect.1password.svc.cluster.local:8080
          connect-token: ${{ secrets.OP_CONNECT_TOKEN }}

      - uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: op://bic45kuflnwsnxnd67dzcnxjze/5p65mbzr237yyzt2sfnfao3a5a/CLAUDE_CODE_OAUTH_TOKEN

      - name: Review PR with Claude
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ env.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          track_progress: true
          claude_args: "--max-turns 30 --model claude-sonnet-4-5-20250929 --json-schema '{\"type\":\"object\",\"properties\":{\"should_approve\":{\"type\":\"boolean\",\"description\":\"Whether to approve the PR (true) or not (false)\"},\"confidence\":{\"type\":\"number\",\"description\":\"Confidence level 0-100 in the approval decision\"},\"issue_count\":{\"type\":\"object\",\"properties\":{\"critical\":{\"type\":\"number\"},\"major\":{\"type\":\"number\"},\"minor\":{\"type\":\"number\"},\"nitpick\":{\"type\":\"number\"}},\"required\":[\"critical\",\"major\",\"minor\",\"nitpick\"]},\"reasoning\":{\"type\":\"string\",\"description\":\"Brief explanation of the approval/rejection decision\"}},\"required\":[\"should_approve\",\"confidence\",\"issue_count\",\"reasoning\"]}'"
          prompt: |
            Review this PR focusing on things linters and typecheckers can't catch:

            - **Architectural fit**: Does this change fit the codebase patterns? Is it in the right place?
            - **Logic errors**: Are there bugs, race conditions, or edge cases that could cause problems?
            - **Security**: Any vulnerabilities that static analysis would miss?
            - **Design**: Is this the right approach? Are there simpler alternatives?
            - **Commit messages**: Are they clear and explain "why"?

            Read the CLAUDE.md file and explore related code to understand context. Use inline comments for specific suggestions. Be direct and concise - if something is fine, don't comment on it.

            ## Issue Severity Classification

            Classify each issue you find:
            - **Critical**: Security vulnerabilities, data loss risks, breaking changes
            - **Major**: Logic errors, race conditions, architectural violations
            - **Minor**: Suboptimal patterns, inconsistencies with conventions
            - **Nitpick**: Style preferences, minor improvements (e.g., variable naming, comment clarity)

            ## Approval Decision

            After your review, determine if this PR should be auto-approved:
            - ✅ **Approve** if: No critical, major, or minor issues exist (nitpicks are okay)
            - ❌ **Do not approve** if: Any critical, major, or minor issues are found

            Provide your decision in the structured output with issue counts and reasoning.

      - name: Auto-approve PR if no issues
        if: |
          steps.claude-review.outputs.structured_output != '' &&
          fromJSON(steps.claude-review.outputs.structured_output).should_approve == true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract data from structured output
          REASONING=$(echo '${{ steps.claude-review.outputs.structured_output }}' | jq -r '.reasoning')
          NITPICK_COUNT=$(echo '${{ steps.claude-review.outputs.structured_output }}' | jq -r '.issue_count.nitpick')
          CONFIDENCE=$(echo '${{ steps.claude-review.outputs.structured_output }}' | jq -r '.confidence')

          # Build approval message
          BODY="✅ **Automated approval by Claude Code Review**

          No blocking issues found (confidence: ${CONFIDENCE}%).

          ${REASONING}

          $(if [ "$NITPICK_COUNT" -gt 0 ]; then echo "${NITPICK_COUNT} nitpick(s) noted in review comments are acceptable and don't block approval."; fi)"

          # Approve the PR
          gh pr review ${{ github.event.pull_request.number }} \
            --approve \
            --body "$BODY"

  # Interactive responses to @claude mentions in comments
  claude-interactive:
    # Only run for comments from shepherdjerred that mention @claude
    if: |
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      github.event.comment.user.login == 'shepherdjerred' &&
      contains(github.event.comment.body, '@claude')
    runs-on: [monorepo-runner-set]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: 1password/load-secrets-action/configure@v2
        with:
          connect-host: http://onepassword-connect.1password.svc.cluster.local:8080
          connect-token: ${{ secrets.OP_CONNECT_TOKEN }}

      - uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: op://bic45kuflnwsnxnd67dzcnxjze/5p65mbzr237yyzt2sfnfao3a5a/CLAUDE_CODE_OAUTH_TOKEN

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ env.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: "@claude"
          track_progress: true
          claude_args: "--max-turns 30 --model claude-sonnet-4-5-20250929"
          prompt: |
            Respond to the question or request. Read CLAUDE.md and relevant code for context. Be direct and concise.
