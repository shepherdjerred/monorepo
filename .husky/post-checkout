#!/usr/bin/env sh

# post-checkout hook receives three parameters:
# $1 = ref of previous HEAD
# $2 = ref of new HEAD
# $3 = flag indicating whether it was a branch checkout (1) or file checkout (0)

# Only run on branch checkout
if [ "$3" = "0" ]; then
  exit 0
fi

# Only run when creating a new worktree
# When a worktree is created, the previous HEAD is all zeros
if [ "$1" != "0000000000000000000000000000000000000000" ]; then
  exit 0
fi

echo "ğŸ”§ New worktree detected! Running setup..."

# Run mise setup if available
if command -v mise >/dev/null 2>&1; then
  echo "ğŸ“‹ Running mise trust..."
  mise trust

  echo "ğŸ”§ Installing mise tools (bun, dagger, etc.)..."
  mise install

  echo "ğŸ“¦ Running mise dev task..."
  mise run dev
else
  echo "âš ï¸  mise not found, falling back to manual setup"

  # Install dependencies with available package manager
  if command -v bun >/dev/null 2>&1; then
    echo "ğŸ“¦ Installing dependencies with bun..."
    bun install
  elif command -v npm >/dev/null 2>&1; then
    echo "ğŸ“¦ Installing dependencies with npm..."
    npm install
  else
    echo "âš ï¸  No package manager found, skipping dependency installation"
  fi
fi

echo "âœ… Worktree setup complete!"
