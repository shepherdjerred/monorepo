# Example: Running Claude Code with the auth proxy
#
# The proxy runs on the host, container has no credentials.
#
# Usage:
#   # Terminal 1: Start the proxy on host
#   ./run-proxy.sh
#
#   # Terminal 2: Start the container
#   docker-compose up claude-code

services:
  # The auth proxy (runs on host network to access host credentials)
  auth-proxy:
    image: mitmproxy/mitmproxy:latest
    network_mode: host
    volumes:
      - ./:/app:ro
    environment:
      # Mount credentials from host environment or use .env file
      - GITHUB_TOKEN
      - ANTHROPIC_API_KEY
      - PAGERDUTY_TOKEN
      - SENTRY_AUTH_TOKEN
      - K8S_TOKEN
      - TALOS_TOKEN
    command: >
      mitmdump
      --listen-host 0.0.0.0
      --listen-port 8080
      --set ssl_insecure=true
      -s /app/proxy.py
      -s /app/k8s_proxy.py
      -s /app/talos_proxy.py

  # Claude Code container - NO CREDENTIALS
  claude-code:
    image: your-claude-code-image:latest
    depends_on:
      - auth-proxy
    environment:
      # Route all traffic through the proxy
      - HTTP_PROXY=http://host.docker.internal:8080
      - HTTPS_PROXY=http://host.docker.internal:8080
      - NO_PROXY=localhost,127.0.0.1

      # Trust the mitmproxy CA (needed for HTTPS interception)
      - NODE_EXTRA_CA_CERTS=/etc/ssl/certs/mitmproxy-ca.pem
      - REQUESTS_CA_BUNDLE=/etc/ssl/certs/mitmproxy-ca.pem
      - SSL_CERT_FILE=/etc/ssl/certs/mitmproxy-ca.pem

      # NO credentials here!
      # - GITHUB_TOKEN      <- NOT SET
      # - ANTHROPIC_API_KEY <- NOT SET
    volumes:
      - ./workspace:/workspace
      # Mount mitmproxy CA cert (generated by mitmproxy on first run)
      - ~/.mitmproxy/mitmproxy-ca-cert.pem:/etc/ssl/certs/mitmproxy-ca.pem:ro
